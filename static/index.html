<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AI Answer Sheet Processor ‚Äî Bulk Mode</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #f4f5fa;
      color: #222;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    h1 {
      background: linear-gradient(90deg, #4a6cf7, #7d47ff);
      color: white;
      padding: 18px 0;
      font-size: 1.8rem;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    .container {
      background: white;
      width: 90%;
      max-width: 900px;
      margin: 30px auto;
      padding: 25px;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    input[type="file"] {
      margin: 15px 0;
      padding: 10px;
      border: 2px dashed #7d47ff;
      border-radius: 10px;
      background: #fafafa;
      width: 80%;
      cursor: pointer;
    }
    button {
      background: #4a6cf7;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    button:hover { background: #374ee0; }

    #loading { display: none; color: #7d47ff; font-weight: bold; margin-top: 10px; }

    /* Image Menu */
    .menu {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-top: 25px;
    }
    .menu-item {
      cursor: pointer;
      border-radius: 10px;
      overflow: hidden;
      border: 2px solid transparent;
      transition: 0.2s ease;
      width: 100px;
      height: 100px;
      position: relative;
    }
    .menu-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .menu-item.active {
      border-color: #4a6cf7;
      box-shadow: 0 0 8px rgba(74,108,247,0.6);
    }
    .menu-item span {
      position: absolute;
      bottom: 4px;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.5);
      color: white;
      font-size: 0.75rem;
      padding: 2px 4px;
    }

    /* Preview Section */
    .file-card {
      margin-top: 25px;
      background: #fafafa;
      border-radius: 14px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.08);
      padding: 18px;
      transition: transform 0.2s ease;
    }
    .file-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }
    .file-header h3 { margin: 0; color: #333; }
    .info-badge {
      background: #eaf0ff;
      color: #4a6cf7;
      border-radius: 6px;
      padding: 6px 10px;
      font-size: 0.9rem;
      font-weight: 600;
    }

    .tabs {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 10px 0;
    }
    .tab {
      padding: 8px 14px;
      border-radius: 8px;
      cursor: pointer;
      background: #eee;
      transition: 0.2s;
      font-weight: 500;
      font-size: 0.95rem;
    }
    .tab.active { background: #4a6cf7; color: white; }

    .preview-area img {
      max-width: 100%;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-top: 10px;
    }

    .debug-gallery {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 12px;
      margin-top: 10px;
    }
    .debug-gallery img {
      max-width: 45%;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .debug-gallery p {
      margin-top: 4px;
      font-size: 0.85rem;
      color: #555;
    }
  </style>
</head>
<body>
  <h1>AI Answer Sheet Processor (Bulk Mode)</h1>

  <div class="container">
    <input type="file" id="fileInput" accept="image/*" multiple>
    <br>
    <button id="uploadBtn">Upload & Process</button>
    <p id="loading">‚è≥ Processing... Please wait</p>

    <div id="menu" class="menu" style="display:none;"></div>
    <div id="resultContainer"></div>
  </div>

  <script>
    const uploadBtn = document.getElementById('uploadBtn');
    const loading = document.getElementById('loading');
    const menu = document.getElementById('menu');
    const resultContainer = document.getElementById('resultContainer');
    let allData = [];

    uploadBtn.onclick = async () => {
      const files = document.getElementById('fileInput').files;
      if (!files.length) return alert('Please select one or more images first!');

      const formData = new FormData();
      for (let f of files) formData.append('files', f);

      loading.style.display = 'block';
      menu.style.display = 'none';
      resultContainer.innerHTML = '';

      const res = await fetch('/process/', { method: 'POST', body: formData });
      const data = await res.json();
      loading.style.display = 'none';

      if (data.error) {
        resultContainer.innerHTML = `<p style="color:red;">‚ö†Ô∏è ${data.error}</p>`;
        return;
      }

      allData = data;
      renderMenu(data);
      showFile(0); // show first file by default
    };

    function renderMenu(data) {
      menu.style.display = 'flex';
      menu.innerHTML = '';
      data.forEach((img, i) => {
        const div = document.createElement('div');
        div.classList.add('menu-item');
        if (i === 0) div.classList.add('active');
        div.innerHTML = `
          <img src="${img.original}?t=${Date.now()}">
          <span>${img.filename.split('.')[0]}</span>
        `;
        div.onclick = () => {
          document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
          div.classList.add('active');
          showFile(i);
        };
        menu.appendChild(div);
      });
    }

    function showFile(i) {
      const img = allData[i];
      const id = `preview-${i}`;
      resultContainer.innerHTML = `
        <div class="file-card">
          <div class="file-header">
            <h3>üìÑ ${img.filename}</h3>
            <div class="info-badge">Angle: ${img.angle}¬∞ | Time: ${img.time}s</div>
          </div>
          <div class="tabs">
            <div class="tab active" id="tab-orig-${i}">Original</div>
            <div class="tab" id="tab-clean-${i}">Cleaned</div>
            <div class="tab" id="tab-align-${i}">Aligned</div>
            <div class="tab" id="tab-debug-${i}">Debug</div>
          </div>
          <div id="${id}" class="preview-area">
            <img src="${img.original}?t=${Date.now()}">
            <p style="margin-top:8px;font-weight:500;color:#555;">üìÑ Original Uploaded Image</p>
          </div>
        </div>
      `;

      const tabs = resultContainer.querySelectorAll('.tab');
      const previewArea = document.getElementById(id);

      tabs.forEach(tab => {
        tab.onclick = () => {
          tabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          if (tab.id.includes('orig'))
            previewArea.innerHTML = `<img src="${img.original}?t=${Date.now()}"><p>üìÑ Original Uploaded Image</p>`;
          else if (tab.id.includes('clean'))
            previewArea.innerHTML = `<img src="${img.cleaned}?t=${Date.now()}"><p>üßπ Cleaned Image</p>`;
          else if (tab.id.includes('align'))
            previewArea.innerHTML = `<img src="${img.aligned}?t=${Date.now()}"><p>üìê Aligned Image (Angle: ${img.angle}¬∞)</p>`;
          else if (tab.id.includes('debug')) {
            const div = document.createElement('div');
            div.classList.add('debug-gallery');
            if (img.debugs && img.debugs.length)
              div.innerHTML = img.debugs.map(d => `
                <div>
                  <img src="${d.url}?t=${Date.now()}">
                  <p>${d.label}</p>
                </div>
              `).join('');
            else div.innerHTML = `<p>No debug images available.</p>`;
            previewArea.innerHTML = '';
            previewArea.appendChild(div);
          }
        };
      });
    }
  </script>
</body>
</html>
